<!DOCTYPE html>
<html>
    <head>
        <title>KLabeler - Vid2Player</title>
        <meta charset="utf-8"/>

        <style>

            body {
                font-family: Helvetica, Arial, sans-seris;
                font-size: 10pt;
                color: #c0c0c0;
                background: #404040;
                padding: 30px;
            }

            body a {
                color: #d0d0d0;
            }

            .bold_text {
                font-weight: bold;
            }

            td button {
                width: 100%;
            }

            #header {
                font-size: 32pt;
                padding-bottom: 20px;
            }

        </style>

        <script src="../kmath.js"></script>
        <script src="../kutils.js"></script>
        <script src="../klabel.js"></script>

        <script>

            var main_canvas_id = 'main_canvas';   // this is the DOM canvas element 
            var labeler = new ImageLabeler;
            var server_url = "http://localhost:1234";
            var fs;

            async function handle_onload() {
                var main_canvas = document.getElementById(main_canvas_id);

                // Initialize the labeler
                labeler.init(main_canvas);
                labeler.set_annotation_mode(Annotation.ANNOTATION_MODE_EXTREME_POINTS_BBOX);

                // Initialize file input
                const fileInput = document.getElementById("upload_file");
                fileInput.addEventListener("change", load_frames_from_file, false);

                // Initialize UI buttons and set labeler accordingly
                var select = document.getElementById("select_annotation_mode");
                select.value = "box_extreme_points";
                labeler.set_annotation_mode(Annotation.ANNOTATION_MODE_EXTREME_POINTS_BBOX);

                var button = document.getElementById("toggle_pt_viz_button");
                button.toggle_status = true;
                labeler.set_extreme_points_viz(button.toggle_status);

                button = document.getElementById("toggle_sound_button");
                button.toggle_status = false;
                labeler.set_play_audio(button.toggle_status);

                button = document.getElementById("toggle_letterbox_button");
                button.toggle_status = true;
                labeler.set_letterbox(button.toggle_status);

                // HACK(kayvonf): intercept key events and send them to the labeler
                // There's likely a much better way to do this.
                // The problem is that the Klabeler canvas DOM element needs to have
                // keyboard focus in order to accept key events. I'm not certain I
                // want to do that right now, since other elements of the HTML page
                // might want keyboard focus, so for now I'm going to send all key
                // events on the page to the KLabeler cnavas.
                window.addEventListener("keydown", function(e) {
                    e.preventDefault();
                    labeler.handle_keydown(e);
                });

                window.addEventListener("keyup", function(e) {
                    e.preventDefault();
                    labeler.handle_keyup(e);
                });

                // Initialze video selection
                fs = await get_fs();
                var select_video = document.getElementById("select_video")

                for (var video in fs) {
                    var option = document.createElement("option");
                    option.value = video;
                    option.text = video;
                    select_video.appendChild(option);
                }

                // Toggle first video, defaults to first point, and loads frames
                handle_video_select();
            }

            function toggle_extreme_points_display() {
                var button = document.getElementById("toggle_pt_viz_button");
                var new_status = !button.toggle_status;
                labeler.set_extreme_points_viz(new_status);
                button.toggle_status = new_status;

                if (new_status == false) {
                    button.innerHTML = 'Show Extreme Points';
                } else {
                    button.innerHTML = 'Hide Extreme Points';
                }
            }

            function toggle_sound() {
                var button = document.getElementById("toggle_sound_button");
                var new_status = !button.toggle_status;
                labeler.set_play_audio(new_status);
                button.toggle_status = new_status;

                if (new_status == false) {
                    button.innerHTML = 'Turn Sound On';
                } else {
                    button.innerHTML = 'Turn Sound Off';
                }		
            }

            function toggle_letterbox() {
                var button = document.getElementById("toggle_letterbox_button");
                var new_status = !button.toggle_status;	
                labeler.set_letterbox(new_status);
                button.toggle_status = new_status;

                if (new_status == false) {
                    button.innerHTML = 'Use Letterbox View';
                } else {
                    button.innerHTML = 'Use Scaled View';
                }
            }

            function handle_mode_change() {
                var select = document.getElementById("select_annotation_mode");
                if (select.value.localeCompare("box_extreme_points") == 0) {
                    labeler.set_annotation_mode(Annotation.ANNOTATION_MODE_EXTREME_POINTS_BBOX);
                } else if (select.value.localeCompare("box_two_points") == 0) {
                    labeler.set_annotation_mode(Annotation.ANNOTATION_MODE_TWO_POINTS_BBOX);
                } else if (select.value.localeCompare("point") == 0) {
                    labeler.set_annotation_mode(Annotation.ANNOTATION_MODE_POINT);
                } else if (select.value.localeCompare("per_frame") == 0) {
                    labeler.set_annotation_mode(Annotation.ANNOTATION_MODE_PER_FRAME);
                }
            }

            function handle_clear_boxes() {
                labeler.clear_boxes();
            }

            function handle_get_annotations() {
                var results = labeler.get_annotations();
                console.log(results);
            }

            function handle_persist_annotations() {
                labeler.save_annotations_to_local_storage();
                labeler.persist_local_storage();
                console.log("KLabeler: persisted localStorage to file")
            }

            //------------------------------------------------------------------------
            // Functions for loading frames, interfacing with server
            //------------------------------------------------------------------------

            function validate_response(r) {
                if (!r.ok) throw Error(r.statusText);
                return r
            }

            function get_fs() {
                return fetch(`${server_url}/fs`)
                    .then(validate_response)
                    .then(r => r.json());
            }

            // Given a path for an image, create a local URL and store in ImageData
            // Note: we must return the original path as well to be able to sort
            // the ImageData by name, and display the stack correctly!
            function fetch_image(path) {
                return fetch(path)
                    .then(validate_response)
                    .then(res => res.blob())
                    .then(blob => URL.createObjectURL(blob))
                    .then(url => new ImageData(url, name=path));
            }

            function get_frames_and_update_labeler(video, point) {
                // Get all the files for the given point
                fetch(`${server_url}/frames/${video}/${point}`)
                    .then(validate_response)
                    .then(r => r.json())
                    .then(filenames => {
                        console.log(`KLabeler: requesting frames for ${video}, ${point}`);
                        // console.log(`Frames: ${filenames}`);
                        return filenames;
                    })
                // For each file, request its frame. Wrap all requests in Promise union
                    .then(filenames => Promise.all(
                        filenames.map(path => fetch_image(`${server_url}/frame/${video}/${point}/${path}`))
                    ))
                // Load into labeler
                    .then(image_dataset => labeler.load_image_stack(image_dataset));
            }


            function handle_video_select() {
                var current_video = document.getElementById("select_video").value;
                var select_point = document.getElementById("select_point")

                // Clear current children
                select_point.innerHTML = '';

                for (var point of fs[current_video].sort()) {
                    var option = document.createElement("option");
                    option.value = point;
                    option.text = point;
                    select_point.appendChild(option);
                }

                // Load frames for first point
                load_frames_for_selection();
            }

            function load_frames_for_selection() {
                // Save current annotation before changing video
                labeler.save_annotations_to_local_storage();

                // Update labeler for new point / video
                var current_video = document.getElementById("select_video").value;
                var current_point = document.getElementById("select_point").value;
                get_frames_and_update_labeler(current_video, current_point);
            }

            function load_frames_from_file() {
                var reader = new FileReader();
                reader.onload = (e) => {
                    let j = JSON.parse(reader.result);
                    console.log("j: ", j)
                    for (var k in j) {
                        localStorage.setItem(k, j[k]);
                        labeler.render()
                    }
                };
                reader.readAsText(this.files[0]);
            }

        </script>
    </head>

    <body onload="handle_onload()">
        <div id="header">
            KLabeler - Vid2Player
        </div>

        <div id="inputs">
            <table cellpadding="0" cellspacing="10" border="0">
                <tr>
                    <td>
                        Video:
                    </td>
                    <td>
                        <select id="select_video" onchange="handle_video_select()">
                        </select>
                    </td>
                    <td>
                        Point:
                    </td>
                    <td>
                        <select id="select_point" onchange="load_frames_for_selection()">
                        </select>
                    </td>
                    <td>
                        Load in annotations from file:
                    </td>
                    <td>
                        <input type="file" accept="*" name="upload_file" id="upload_file" />
                    </td>
                </tr>
            </table>


        </div>

        <p style="width: 960px; border-top: 1px solid #606060; padding-top: 10px;">

        <div id="labeled_div">
            <canvas id="main_canvas" width="960" height="500" style="border: 8px solid #c0c0c0;" ></canvas>
        </div>

        <p style="width: 960px; border-top: 1px solid #606060; padding-top: 10px;">

        <div>
            <table cellpadding="0" cellspacing="5" border="0">
                <tr>
                    <td width="100">
                        Mode:
                    </td>
                    <td>
                        <select id="select_annotation_mode" onchange="handle_mode_change()">
                            <option value="box_extreme_points">Box (via extreme points)</option>
                            <option value="box_two_points">Box (via two corner clicks)</option>
                            <option value="point">Point</option>
                            <option value="per_frame">Per Frame</option>
                        </select>
                    </td>
                    <td>
                        <button id="toggle_pt_viz_button" type="button" onclick="toggle_extreme_points_display()">
                            Hide Extreme Points
                        </button>
                    </td>
                    <td>
                        <button id="toggle_sound_button" type="button" onclick="toggle_sound()">
                            Turn Sound On
                        </button>
                    </td>
                    <td>
                        <button id="toggle_letterbox_button" type="button" onclick="toggle_letterbox()">
                            Use Scaled View
                        </button>
                    </td>
                </tr>
                <tr>
                    <td>
                        Annotations:
                    </td>
                    <td>
                        <button id="persist_annotations" type="button" onclick="handle_persist_annotations()">
                            Persist Annotations
                        </button>
                    </td>
                    <td>
                        <button id="clear_button" type="button" onclick="handle_clear_boxes()">
                            Clear Annotations
                        </button>
                    </td>
                    <td>
                        <button id="get_annotations" type="button" onclick="handle_get_annotations()">
                            Log Annotations
                        </button>
                    </td>
                </tr> 
            </table>


            <p style="width: 960px; border-top: 1px solid #606060; padding-top: 10px;">

            <div class="bold_text">Annotation:</div>

            <tr>
                <td width="175">Extreme points box mode:</td>
                <td>Click four times to draw a box.  (Use the <a href="https://arxiv.org/abs/1708.02750" target="_blank">extreme clicking</a> technique: leftmost, topmost, rightmost, bottommost)</td>
            </tr>
            <tr>
                <td>Two-point box mode:</td>
                <td>Two clicks to define the corners of the bounding box.</td>
            </tr> 
            <tr>
                <td>Point mode:</td>
                <td>Single click to define a point</td>
            </tr>
            <tr>
                <td>Per-frame mode:</td>
                <td>Single click anywhere to mark/unmark the frame. (spacebar also works)</td>
            </tr>
            </table>
            <div>Press 'ESC' to abort current box.</div>

            <p>
            <div class="bold_text">Selection:</div>	
            <div>Hover over boxes/points to select them. Press Backspace to delete the selected item. (Selection picks the smallest area box containing the cursor.)</div>
            </p>
            <p>
            <div class="bold_text">Zooming:</div>
            <div>Hold 'z' and draw a two-point box to zoom the view to that box.</div>
            <div>Press 'r' to reset zoom state (zoom all the way out)</div>
            </p>

            <p>
            <div class="bold_text">Image Stack Navigation:</div>
            <div>Left/right arrow keys or A/D keys to move from frame to frame in the current batch of frames.</div>
            </p>


            <p>
            <div class="bold_text">Shot/bounce Types</div>
            <div>(1) serve</div>
            <div>(2) fh_topspin</div>
            <div>(3) bh_topspin</div>
            <div>(4) fh_slice</div>
            <div>(5) bh_slice</div>
            <div>(6) fh_volley</div>
            <div>(7) bh_volley</div>
            <div>(8) overhead</div>
            <div>(9) special</div>
            <div>(q) bounce_in</div>
            <div>(w) bounce_out</div>
            <div>(e) bounce_net</div>
            </p>

            <p>
            <div class="bold_text">Instructions for Vid2Player annotation</div>
            <div>(1) Please label contact point, shot type and bounce point for all shots of the two players</div>
            <br>
            <div>(2) Contact point: first find the frame when contact happens, then click on the ball's position as contact point. (If the real contact point is between two frames due to the low frame rate, please label the contact in the frame closer to the real contact. If it is hard to tell which is closer, you can choose the former frame between the two. In case the contact is in-between, you may also need to estimate the true contact point given the racket position, instead of simply mark the ball in that frame)</div>
            <br>
            <div>(3) Bounce point: click on the ball's position at the time of ball bounce </div>
            <br>
            <div>(4) Shot/bounce type: type numbers/letters shown above when hovering over the contact/bounce point</div>
            <br>
            <div>(5) <strong>Please make sure you label N contact points and also N bounce points in a single point: (a) If the video starts after serve contact, please start your label with the first visible contact point (b) If the next shot is volley, please roughly estimate a bounce point (position and time), i.e. the timing will be volley contact at time T, estimated bounce at time T + m, volley bounce at time T + m + n </strong></div>
            <br>
            <div>(6) By default, all bounces except the last one should be labeled as "bounce_in", the last bounce type should indicate the point outcome. i.e. "bounce_in" for winner, "bounce_out" for out, "bounce_net" for net error. If the ball is hit into net, please estimate a bounce point (position and time) on the court if there was no net (no need to label the bounce point on the net). </div>
            <br>
            <div>(7) Please label a half-volley as <strong>fh_volley</strong> or <strong>bh_volley</strong>. Half-volley means the player makes their shot near the serveline although they let the ball bounce before they strike the ball. </div>
            <br>
            <div>(8) An example labeling is provided, at the top page. Please set the Video to be "example_video", and choose file "klabel/vid2player/example_annotation.json" to load the example annotations. Then you can check the two points and go through the frames to view the annotations.  </div>
            </p>

    </body>
</html>
